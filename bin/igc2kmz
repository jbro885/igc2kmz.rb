#!/usr/bin/ruby

$:.unshift(File.join(File.dirname(__FILE__), "..", "lib"))
require "igc"
require "igc/kmz"
require "optparse"
require "photo"
require "rexml/document"
require "task/gpx"
require "uri"

TIME_REGEXP = /\A([+\-])?([0-9]|1[01])(?::([0-5][0-9]))?\z/

def main(argv)
  hints = IGC.default_hints
  OptionParser.new do |op|
    op.on("-c", "--color COLOR", "Color") do |arg|
      hints.color = KML::Color.color(arg)
    end
    op.on("-k", "--complexity COMPLEXITY", Integer, "Complexity") do |arg|
      hints.complexity = arg
    end
    op.on("-P", "--pilot NAME", String, "Pilot") do |arg|
      hints.pilot = arg
    end
    op.on("-p", "--photo-tz-offset OFFSET", TIME_REGEXP, "Photo timezone offset") do |arg|
      hints.photo_tz_offset = (60 * arg[2].to_i + arg[3].to_i) * (arg[1] == "-" ? -60 : 60)
    end
    op.on("-t", "--task FILENAME", String, "Task") do |arg|
      hints.task = Task.new_from_gpx(REXML::Document.new(File.open(arg)).root.elements["rte"])
    end
    op.on("-u", "--units UNITS", [:metric, :imperial, :nautical], "Units (metric|imperial)") do |arg|
      hints.units = arg
    end
    op.on("-w", "--width WIDTH", "Width", Integer) do |arg|
      hints.width = arg.constrain(1)
    end
    op.on("-x", "--xc-league LEAGUE", Optima::LEAGUES.keys, "XC league") do |arg|
      hints.league = arg
    end
    op.on("-z", "--tz-offset OFFSET", TIME_REGEXP, "Timezone offset") do |arg|
      hints.tz_offset = (60 * arg[2].to_i + arg[3].to_i) * (arg[1] == "-" ? -60 : 60)
    end
    op.parse!(argv)
  end
  igc = nil
  argv.each do |arg|
    if /\.igc\z/i.match(arg)
      raise if igc
      File.open(arg) do |io|
        igc = IGC.new(io)
      end
    else
      hints.photos << Photo.new(arg)
    end
  end
  raise unless igc
  igc.to_kmz(hints).write("#{igc.filename}.kmz", :open => 1)
end

main(ARGV) if $0 == __FILE__
